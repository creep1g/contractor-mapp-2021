import React, { useState, useEffect } from 'react';
import {Linking, Alert, View, Text, Image, TouchableHighlight, Platform } from 'react-native';
import styles from './styles';
import Buttons from '../../components/ButtonArray';
import EditModal from '../../components/EditModal';
import * as FileService from '../../services/fileService';

const Details = function( {route} ){
  
  const { user, contacts, setContacts, filteredContacts, setFilteredContacts } = route.params;
  
  const [ currUser, setCurrUser ] = useState(user);

  const [ gotUser, setGotUser ] = useState(null);

  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
	
  // Update currUser
 const updateContact = async ( input ) => {
  const updatedContact = {
    id: currUser.id,
	name: input.name,
	image: input.image,
	number: input.number,
	location: '',
	};
	await FileService.removeContact(currUser.location);
	setCurrUser(updatedContact);
	updatedContact.location = await FileService.addContact(updatedContact);
	setIsEditModalOpen(false);
	setFilteredContacts(filteredContacts.filter((contact) => contact.id !== updatedContact.id))
	setFilteredContacts([...filteredContacts, updatedContact]);
	// setContacts(contacts.filter((contact) => contact.id !== updatedContact.id))
	// setContacts([...contacts, updatedContact]);
 };

  // Asyncronousy get access to user file
  useEffect(() => {
    async function get() {
	  contact = await FileService.loadForUpdate(user.location)
	  setGotUser(contact)
	  }
	  get();
  }, []);

 
  // Opens phone app to call 
  const callNumber = ( phone ) => {
		let phoneNumber = phone;
		if (Platform.OS !== 'android'){
			phoneNumber = `tel:${phone}`;
		}
		else{
			phoneNumber = `tel:${phone}`;
			}
		Linking.canOpenURL(phoneNumber).then(() =>{
				return Linking.openURL(phoneNumber);
		})
			.catch((err) => console.log(err));
	}

  // Same as call but opens text messaging application
  const textNumber = ( phone ) => {
	let phoneNumber = phone;
	if (Platform.OS !== 'android'){
		phoneNumber = `sms:${phone}`;
	}
	else{
		phoneNumber = `sms:${phone}`;
	}
	Linking.canOpenURL(phoneNumber).then(() =>{
			return Linking.openURL(phoneNumber);
	})
		.catch((err) => console.log(err));
}


  return(	
	<View style={{flex: 1}}>
		{/* Top heading with contact name and image */}
		<View style={styles.heading}>
			{
			  currUser.image !== ""
			?
			  <Image 
			  style={	styles.image	}
			  source={{ uri: currUser.image }}
			  resizeMode={ 'cover' } />
			:
			  <View style={ [ styles.image, { backgroundColor: "#393E42" }] }>
			  	<Text style={{fontSize: 80, 
				              textAlign:'center', 
				  	    	  color:'white'}}>
				  	{ currUser.name[0] }
				  </Text>
				</View>
			}
			<Text style={styles.name}>{ currUser.name }</Text>
		</View>

	{/* Buttons ! */}
	<Buttons 
		makeCall={() => callNumber(currUser.number)}
		sendText={() => textNumber(currUser.number)}
		editContact={() => setIsEditModalOpen(true)}
	/>
		

		<TouchableHighlight 
			style={ styles.card }
			activeOpacity={ 0.6 }
			underlayColor={ 'darkgray' }
			onPress={() => callNumber(currUser.number)}
		>
			<View style={ { flex: 1 } }>
				<Text style={ styles.phone }>Phone</Text>
				<Text style={ styles.number }>{ currUser.number }</Text>
			</View>
		</TouchableHighlight>

      <EditModal
        isOpen={isEditModalOpen}
        closeModal={() => setIsEditModalOpen(false)}
		user={gotUser}
	    updateContact={(input) => updateContact(input)}
      />
	</View>
	)

};


export default Details;
